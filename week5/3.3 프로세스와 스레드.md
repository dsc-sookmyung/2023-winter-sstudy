## 3.3 프로세스와 스레드

---

### 3.3.1 프로세스와 컴파일 과정

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/71616d2d-4892-4881-93be-7b760bd11a83/Untitled.heic)

- 1️⃣ 전처리
    - 소스 코드의 주석 제거
    - 헤더 파일 병합하여 매크로 치환
- 2️⃣ 컴파일러
    - 오류 처리, 코드 최적화 작업
    - 어셈블리어로 변환
- 3️⃣ 어셈블러
    - 어셈블리어 → 목적 코드로 변환
    - 확장자 운영체제마다 다름
- 4️⃣ 링커
    - 라이브러리 함수 또는 다른 파일들과 목적 코드 결합 → 실행파일 생성
    - 확장자 `.exe` 또는 `.out`

- **💡 라이브러리 종류**
    - `정적 라이브러리`
        - 프로그램 빌드 시 라이브러리가 제공하는 모든 코드를 실행 파일에 넣는 방식
        - 외부 의존도가 낮음
        - 코드 중복 등 메모리 효율성 떨어짐
    - `동적 라이브러리`
        - 프로그램 실행 시 필요할 때만 DLL 함수 정보를 통해 참조하여 라이브러리를 쓰는 방법
        - 외부 의존도 높음
        - 메모리 효율성 높음

### 3.3.2 프로세스의 상태

- `생성 상태`
    - 프로세스가 생성된 상태
    - PCB 할당
    - fork()
        - 부모 프로세스의 주소 공간 복사 (비동기 작업 상속 X)
        - 새로운 자식 프로세스 생성
    - exec()
        - 새롭게 프로세스를 생성
- `대기 상태`
    - 메모리 공간 충분하지 않은 상태
    - CPU 스케줄러로부터 CPU 소유권이 넘어오길 기다림
- `대기 중단 상태`
    - 메모리 부족으로 일시 중단된 상태
- `실행 상태`
    - CPU 소유권과 메모리 할당 받음
    - 인스트럭션을 수행 중인 상태
- `중단 상태`
    - 어떤 이벤트 발생 후 기다리며 프로세스가 차단된 상태
    - I/O 디바이스 인터럽트에 이런 현상 많이 발생
- `일시 중단 상태`
    - 대기 중단 상태와 유사
    - 중단된 상태에서 프로세스가 실행되려고 했으나 메모리 부족으로 일시 중단 상태
- `종료 상태`
    - 메모리와 CPU 소유권을 모두 높고 가는 상태
    - 비자발적 종료(abort) 존재
        - 자식 프로세스에 할당된 자원의 한계치를 넘어서는 경우
        - 부모 프로세스가 종료되는 경우
        - 사용자가 process.kill 명령어로 종료하는 경우

### 3.3.3 프로세스의 메모리 구조

- 동적 영역 : **런타임 단계**에서 메모리 할당
    - `스택`
        - 위 주소부터 할당
        - 지역 변수, 매개변수, 실행되는 함수
        - 늘어나거나 줄어드는 메모리 영역
        - 함수가 호출될 때 마다 호출될 때의 환경 등 특정 정보가 스택에 계속해서 저장됨
        - 함수 내의 변수 집합이 해당 함수의 다른 인스턴스 변수를 방해하지 않음
    - `힙`
        - 아래 주소부터 할당
        - 동적으로 할당되는 변수를 담음
        - .malloc(), free() 함수를 통해 관리
        - 동적으로 관리되는 자료 구조가 사용됨
- 정적 영역 : **컴파일 단계**에서 메모리 할당
    - `데이터 영역`
        - **BBS segment :** 0으로 초기화 또는 초기화 되어있지 않은 변수
        - **Data segment** : 0이 아닌 값으로 초기화 된 변수
    - `코드 영역`
        - 프로그램의 코드가 들어감

### 3.3.4 PCB

- PCB 의미
    - Process Control Block
    - 운영체제에서 프로세스에 대한 메타데이터를 저장한 ‘데이터’
    - 프로세스가 생성되면 운영체제는 해당 PCB 생성

⚠️ 프로그램 실행 → 프로세스 생성 → 프로세스 주소 값들에 스택, 힙 구조를 기반으로 메모리 할당 → 해당 프로세스의 메타데이터는 PCB에 저장되어 관리

> ⚠️ **메타데이터** : 데이터에 관한 구조화된 데이터, 찾고 있는 정보를 효율적으로 찾아내 이용하기 위해 일정한 규칙에 따라 콘텐츠에 대해 부여되는 데이터
> 

- **PCB의 구조**
    - `프로세스 스케줄링 상태` : CPU 소유권 얻은 이후 상태
    - `프로세스 ID` : 해당 프로세스 및 자식 프로세스 ID
    - `프로세스 권한` : 컴퓨터 자원에 대한 권한 정보
    - `프로그램 카운터` : 다음 명령어의 주소에 대한 포인터
    - `CPU 레지스터` : 프로세스 실행을 위한 레지스터 정보
    - `CPU 스케줄링 정보` : CPU 스케줄러에 의해 중단된 시간 등
    - `계정 정보` : 프로세스 실행에 사용된 CPU 사용량, 실행한 유저정보
    - `I/O 상태 정보` : 프로세스에 할당된 I/O 디바이스 목록

- 컨텍스트 스위칭
    - 의미 및 특징
        - PCB를 교환하는 과정
        - 프로세스에 할당된 시간이 끝나거나 인터럽트에 의해 발생
        - 컨텍스트 스위칭 발생 시 유효시간 발생
    - 캐시미스
        - 프로세스가 가지고 있는 메모리 주소가 그대로 있으면 잘못된 주소 변환 발생
        - 캐시클리어 과정을 겪기 때문에 캐시미스 발생
    - 스레드에서 컨텍스트 스위칭
        - 스레드 → 스택 영역을 제외한 모든 메모리 공유
        - 비용이 더 적고 시간도 더 적게 걸림

### 3.3.5 멀티프로세싱

→ 동시에 두 가지 이상의 일을 수행할 수 있는 것

→ 하나 이상의 일을 병렬로 처리

→ 문제 발생되더라도 다른 프로세스를 이용해 처리 가능하여 신뢰성 높음

- 웹 브라우저
    - `브라우저 프로세스`
        - 주소 표시줄, 북마크 막대, 뒤로가기, 앞으로가기 담당
        - 네트워크 요청, 파일 접근 권한 담당
    - `렌더러 프로세스`
        - 웹사이트에 ‘보이는’ 부분 제어
    - `플러그인 프로세스`
        - 웹사이트에서 사용하는 플로그인 제어
    - `GPU 프로세스`
        - GPU를 이용해 화면을 그리는 부분 제어
- IPC (Inter Process Communication)
    - 공유 메모리
        - 여러 프로세스에 동일한 메모리 블록에 대한 접근 권한이 부여되어 프로세스가 서로 통신할 수 있도록 공유 메모리를 생성해서 통신
    - 파일
        - 디스크에 저장된 데이터
        - 파일 서버에서 제공한 데이터
        - 이를 통해 프로세스 간 통신
    - 소켓
        - 동일한 컴퓨터의 다른 프로세스나 네트워크의 다른 컴퓨터로 네트워크 인터페이스를 통해 전송하는 데이터
        - TCP 와 UDP
    - 익명 파이프
        - 프로세스 간에 FIFO 방식으로 읽히는 임시 공간인 파이프를 기반으로 데이터를 주고 받음
        - 단방향 방식의 읽기 전용, 쓰기 전용 파이프를 만들어서 작동하는 방식
    - 명명된 파이프
        - 파이프 서버와 하나 이상의 파이프 클라이언트 간의 통신을 위한 명명된 단방향 또는 양방향 파이프
        - 클라이언트/서버 통신을 위한 별도의 파이프 제공
        - 여러 파이프를 동시에 사용 가능
        - 컴퓨터의 프로세스끼리 또는 다른 네트워크 상의 컴퓨터와도 통신 가능
    - 메시지 큐
        - 데이터 구조 형태로 관리하는 것
        - 커널의 전역변수 현태 등 커널에서 전역적으로 관리됨
        - 다른 IPC 방식에 비해 사용 방법이 매우 직관적 및 간단
        - 간단한 코드를 추가시켜 메시지 큐에 접근 가능
